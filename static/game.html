<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slime Collector</title>
    <style>
        :root {
            --primary: #4CAF50;
            --secondary: #8BC34A;
            --dark: #2E7D32;
            --light: #C8E6C9;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Rubik', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--light), #E8F5E9);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--primary);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .game-area {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .slime-display {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        #slime-image {
            width: 200px;
            height: 200px;
            object-fit: contain;
            margin: 15px auto;
            transition: transform 0.3s ease;
        }
        
        #slime-image:hover {
            transform: scale(1.05);
        }
        
        .slime-info {
            margin: 15px 0;
        }
        
        #spin-button {
            background-color: var(--secondary);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        #spin-button:hover {
            background-color: var(--dark);
            transform: translateY(-3px);
        }
        
        #spin-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .inventory-area {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
        }
        
        .toggle-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }
        
        .toggle-button img {
            width: 30px;
            height: 30px;
        }
        
        #inventory, #crafter {
            display: none;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background-color: #f9f9f9;
        }
        
        .slime-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .slime-item img {
            width: 50px;
            height: 50px;
            margin-right: 15px;
            object-fit: contain;
        }
        
        .craft-recipe {
            background-color: #E8F5E9;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .craft-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .craft-item img {
            width: 40px;
            height: 40px;
            margin-right: 10px;
        }
        
        .craft-button {
            background-color: var(--secondary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .craft-button:hover {
            background-color: var(--dark);
        }
        
        @media (max-width: 768px) {
            .game-area {
                flex-direction: column;
            }
        }
        
        .save-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .save-button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .save-button:hover {
            background-color: #0b7dda;
        }
        
        .animation-container {
            position: relative;
            height: 220px;
            overflow: hidden;
        }
        
        .spinning-effect {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 200px;
            background: rgba(139, 195, 74, 0.1);
            border-radius: 50%;
            display: none;
            z-index: 2;
        }
        
        .rarity-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-top: 5px;
            color: white;
        }
        
        .common { background: #4CAF50; }
        .uncommon { background: #2196F3; }
        .rare { background: #9C27B0; }
        .epic { background: #FF9800; }
        .legendary { background: #F44336; }
        .mythic { background: #E91E63; }
        .divine { background: #FFEB3B; color: #333; }
        
        .crafted-badge {
            background-color: #4CAF50;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
        }
        
        .craft-error {
            animation: shake 0.5s;
            border: 2px solid red;
        }
        
        @keyframes shake {
            0%, 100% {transform: translateX(0);}
            20%, 60% {transform: translateX(-5px);}
            40%, 80% {transform: translateX(5px);}
        }
        
        @keyframes spin {
            0% { transform: translateX(-50%) scale(0.5); opacity: 0; }
            50% { transform: translateX(-50%) scale(1.2); opacity: 0.5; }
            100% { transform: translateX(-50%) scale(0.5); opacity: 0; }
        }

        .toggle-container {
            display: flex;
            align-items: center;
            margin: 10px 0;
            justify-content: center;
        }

        .toggle-label {
            margin-right: 10px;
            font-size: 14px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .collections-area {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        .collection-item {
            display: flex;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background-color: #f9f9f9;
            align-items: center;
        }
        
        .collection-thumbnail {
            width: 80px;
            height: 80px;
            margin-right: 15px;
            object-fit: contain;
            border-radius: 8px;
            border: 2px solid #ddd;
        }
        
        .collection-details {
            flex: 1;
        }
        
        .collection-slimes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }
        
        .collection-slime {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            background-color: #e0f7fa;
            border-radius: 15px;
            font-size: 14px;
        }
        
        .collection-slime img {
            width: 20px;
            height: 20px;
            margin-right: 5px;
        }
        
        .collection-reward {
            background-color: #fff8e1;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: bold;
            margin-top: 5px;
            display: inline-block;
        }
        
        .collection-progress {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--primary);
            transition: width 0.5s ease;
        }
        
        .collection-status {
            font-weight: bold;
            padding: 8px 12px;
            border-radius: 5px;
            text-align: center;
            margin-top: 10px;
        }
        
        .locked {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .completed {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .claim-button {
            background-color: var(--secondary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        
        .claim-button:hover {
            background-color: var(--dark);
        }
        
        .claim-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .index-area {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        .slime-index-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .slime-index-item {
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            background: #f9f9f9;
            transition: transform 0.2s;
        }
        
        .slime-index-item:hover {
            transform: translateY(-5px);
            background: #e8f5e9;
        }
        
        .slime-index-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e0e0e0;
            border-radius: 50%;
            font-size: 30px;
            color: #9e9e9e;
        }
        
        .slime-index-item.known .slime-index-icon {
            background: transparent;
        }
        
        .slime-index-name {
            margin-top: 8px;
            font-weight: bold;
        }
        
        .slime-index-rarity {
            font-size: 12px;
            margin-top: 3px;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            color: white;
        }
        
        .slime-index-unknown {
            filter: blur(5px);
            opacity: 0.7;
        }
        .rarity-badge.unknown {
            background: #9e9e9e;
        }
        .toggle-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .toggle-buttons {
            display: flex;
            gap: 10px;
        }
        
        .toggle-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .toggle-btn:hover {
            background: var(--dark);
        }
        
        /* Стили для уведомлений */
        #cheat-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff9800, #f44336);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            font-family: 'Rubik', sans-serif;
            animation: cheatSlide 0.5s ease-out;
        }
        
        @keyframes cheatSlide {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes cheatFade {
            to { opacity: 0; transform: translateY(-20px); }
        }
        .cheat-message {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .cheat-label {
            font-size: 14px;
            opacity: 0.8;
            text-align: right;
        }
        
        /* Стили для эффектов */
        .active-effect {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .active-effect img {
            margin-right: 10px;
            border-radius: 4px;
            width: 30px;
            height: 30px;
        }
        .active-effect div {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Slime Collector</h1>
            <p>Собирай редких слаймов и создавай уникальные предметы!</p>
        </header>
        
        <div class="game-area">
            <div class="slime-display">
                <div class="animation-container">
                    <img id="slime-image" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNTAiIGhlaWdodD0iMjUwIiB2aWV3Qm94PSIwIDAgMjAwIDIwMCI+PGNpcmNsZSBjeD0iMTAwIiBjeT0iMTAwIiByPSI4MCIgZmlsbD0iIzRjYWY1MCIvPjxjaXJjbGUgY3g9IjcwIiBjeT0iODAiIHI9IjEyIiBmaWxsPSIjZmZmIi8+PGNpcmNsZSBjeD0iMTMwIiBjeT0iODAiIHI9IjEyIiBmaWxsPSIjZmZmIi8+PHBhdGggZD0iTTgwIDEzMHEyMCAyMCA0MCAwIiBzdHJva2U9IiMzMzMiIHN0cm9rZS13aWR0aD0iOCIvPjwvc3ZnPg==" alt="Slime">
                    <div class="spinning-effect" id="spinning-effect"></div>
                </div>
                <div class="toggle-container">
                    <span class="toggle-label">Анимация:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="animation-toggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="slime-info">
                    <h2 id="name">Green Slime</h2>
                    <p>Шанс: <span id="chance">1/2</span></p>
                    <div class="rarity-badge common" id="rarity-badge">Обычный</div>
                </div>
                <button id="spin-button">SPIN!</button>
                
                <div class="save-controls">
                    <button id="save-button" class="save-button">Сохранить</button>
                    <button id="load-button" class="save-button">Загрузить</button>
                    <button id="reset-button" class="save-button">Сбросить прогресс</button>
                </div>
            </div>
           
            <div class="inventory-area">
                <div class="panel-header">
                    <div class="active-effects">
                        <h3>Активные эффекты</h3>
                        <div id="effects-list"></div>
                    </div>
                </div>
                <div class="panel-header">
                    <h2>Инвентарь</h2>
                    <button id="inventory-toggle" class="toggle-button">
                        <img id="backpack-image" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjMDAwIj48cGF0aCBkPSJNMTkgNmgtMlE1IDYgMiA5aDJxMCAzLjMxIDIuNjkgNiA2LTYgNnY1bDQtNCA0IDRWNkgxOXptLTggMTN2LTJoLTJ2LTJoMnYtMmgydjJoMnYyaC0ydjJoLTJ2LTJ6Ii8+PC9zdmc+" alt="Инвентарь">
                    </button>
                </div>
                <div id="inventory">
                    <!-- Инвентарь будет заполняться динамически -->
                </div>
                
                <div class="panel-header">
                    <h2>Крафт</h2>
                    <button id="crafter-toggle" class="toggle-button">
                        <img id="hammer-image" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjMDAwIj48cGF0aCBkPSJNMTMgOS44VjNoLTJ2Ni44Yy0uNTcuMzUtMS4wNi45Ni0xLjA3IDEuN2guMDJjLjAxLjQ1LjIxLjg4LjU2IDEuMjJMMTMgMTUuNDRWMTdINnYtMS41bDEuNDItMS40MkM4LjI3IDEzLjY0IDguNSAxMi44NyA4LjUgMTJjMC0xLjY5LTEuMzUtMy0zLTNzLTMgMS4zNS0zIDNjMCAuODcuMjMgMS42NC42MiAyLjI0TDYgMTUuNVYxOWg3di0zLjZsMi45Mi0yLjkyYy4zNS0uMzQuNTUtLjc3LjU2LTEuMjJoLS4wMWMtLjAxLS43NC0uNS0xLjM1LTEuMDctMS43ek0xOSAxNGMtLjU1IDAtMS0uNDUtMS0xcy40NS0xIDEtMSAxIC40NSAxIDEtLjQ1IDEtMSAxem0wLTJjLS41NSAwLTEtLjQ1LTEtMXMuNDUtMSAxLTEgMSAuNDUgMSAxLS40NSAxLTEgMXoiLz48L3N2Zz4=" alt="Крафт">
                    </button>
                </div>
                <div class="panel-header">
                    <h3>Дополнительные разделы</h3>
                    <div class="toggle-buttons">
                        <button id="toggle-collections" class="toggle-btn">Коллекции</button>
                        <button id="toggle-index" class="toggle-btn">Индекс</button>
                    </div>
                </div>
                <div id="crafter">
                    <!-- Крафт будет заполняться динамически -->
                </div>
            </div>
        </div>
        <div class="collections-area">
            <div class="panel-header">
                <h2>Коллекции слаймов</h2>
            </div>
            <div id="collections">
                <!-- Коллекции будут заполняться динамически -->
            </div>
        </div>
        <div class="index-area">
            <div class="panel-header">
                <h2>Индекс слаймов</h2>
            </div>
            <div id="slime-index">
                <!-- Индекс будет заполняться динамически -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
    const API_URL = 'http://localhost:8000';
    const UNKNOWN_SLIME_IMAGE = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNTAiIGhlaWdodD0iMjUwIiB2aWV3Qm94PSIwIDAgMjAwIDIwMCI+PGNpcmNsZSBjeD0iMTAwIiBjeT0iMTAwIiByPSI4MCIgZmlsbD0iI2QwZDBkMCIvPjx0ZXh0IHg9IjEwMCIgeT0iMTEwIiBmb250LXNpemU9IjcwIiBmb250LWZhbWlseT0iQXJpYWwiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIGZpbGw9IiM2NjYiIGZvbnQtd2VpZ2h0PSJib2xkIj4/PC90ZXh0Pjwvc3ZnPg==";

    // Проверка авторизации
    const authToken = localStorage.getItem('auth_token');
    const userId = localStorage.getItem('user_id');
    if (!authToken || !userId) {
        window.location.href = 'index.html';
    }

    // Глобальные переменные
    let SLIMES = [];
    let CRAFTS = [];
    let COLLECTIONS = [];
    let gameState = {
        multiplier: 10000000,
        harvestMultiplier: 1,
        spinCooldown: 1000,
        rareChanceBoost: 0,
        epicChanceBoost: 0,
        divineChanceMultiplier: 1,
        animationEnabled: true,
        autoSaveEnabled: true,
        collectionsVisible: true,
        indexVisible: true,
        totalSpins: 0,
        rareSlimesFound: 0
    };

    // Элементы DOM
    const slimeImage = document.getElementById("slime-image");
    const spinButton = document.getElementById("spin-button");
    const nameSpan = document.getElementById("name");
    const chanceSpan = document.getElementById("chance");
    const inventory = document.getElementById("inventory");
    const crafter = document.getElementById("crafter");
    const spinningEffect = document.getElementById("spinning-effect");
    const rarityBadge = document.getElementById("rarity-badge");
    const collectionsContainer = document.getElementById("collections");
    const saveButton = document.getElementById("save-button");
    const loadButton = document.getElementById("load-button");
    const resetButton = document.getElementById("reset-button");
    const effectsList = document.getElementById("effects-list");

    // Состояние игры
    let inventoryOpen = false;
    let crafterOpen = false;
    let isSpinning = false;
    let spinQueue = 0;
    let autoSaveInterval;
    let isSaving = false;
    
    // Чит-коды
    const cheatCodes = {
        "ALLSLIMES": () => {
            SLIMES.forEach(slime => {
                slime.amount += 10;
            });
            return "Получено по 10 каждого слайма!";
        },
        "RARE": () => {
            SLIMES.filter(s => s.rarity === "rare").forEach(slime => {
                slime.amount += 5;
            });
            return "Получено по 5 редких слаймов!";
        },
        "EPIC": () => {
            SLIMES.filter(s => s.rarity === "epic").forEach(slime => {
                slime.amount += 3;
            });
            return "Получено по 3 эпических слайма!";
        },
        "LEGENDARY": () => {
            SLIMES.filter(s => s.rarity === "legendary").forEach(slime => {
                slime.amount += 2;
            });
            return "Получено по 2 легендарных слайма!";
        },
        "DIVINE": () => {
            SLIMES.filter(s => s.rarity === "divine").forEach(slime => {
                slime.amount += 1;
            });
            return "Получен божественный слайм!";
        },
        "RESET": () => {
            resetProgress();
            return "Прогресс сброшен!";
        },
        "MASTER": () => {
            SLIMES.forEach(slime => {
                slime.amount += 100;
            });
            CRAFTS.forEach(craft => craft.created = true);
            COLLECTIONS.forEach(collection => {
                collection.completed = true;
                collection.claimed = true;
            });
            return "Статус мастера достигнут!";
        }
    };
    let cheatBuffer = "";
    let cheatSequence = [];

    // Функции API
    async function fetchGameData() {
        try {
            console.log(authToken);
            const response = await axios.get(`${API_URL}/api/load/`, {
                headers: { 'Authorization': `Token ${authToken}` }
            });
            const data = response.data;

            // Обновление состояния игры
            gameState = {
                ...gameState,
                ...data.user,
                harvestMultiplier: data.user.harvest_multiplier,
                spinCooldown: data.user.spin_cooldown,
                rareChanceBoost: data.user.rare_chance_boost,
                epicChanceBoost: data.user.epic_chance_boost,
                divineChanceMultiplier: data.user.divine_chance_multiplier
            };
            
            // Обновление слаймов
            SLIMES = data.inventory.map(item => ({
                ...item.slime_type,
                amount: item.amount,
                image: `${API_URL}${item.slime_type.image}`
            }));
            
            // Обновление крафтов
            CRAFTS = data.crafts.map(craftItem => ({
                ...craftItem.recipe,
                created: craftItem.is_completed,
                image: `${API_URL}${craftItem.recipe.image}`,
                cost: craftItem.recipe.ingredients.map(ing => ({
                    name: ing.slime_type.name,
                    amount: ing.amount
                }))
            }));
            
            // Обновление коллекций
            COLLECTIONS = data.collections.map(colItem => ({
                ...colItem.collection,
                completed: colItem.completed,
                claimed: colItem.claimed,
                thumbnail: `${API_URL}${colItem.collection.thumbnail}`,
                slimes: colItem.collection.requirements.map(req => ({
                    name: req.slime_type.name,
                    amount: req.amount
                }))
            }));
            
            // Обновление интерфейса
            updateAnimationToggle();
            renderAll();
            renderActiveEffects();
        } catch (error) {
            console.error('Ошибка загрузки данных:', error);
        }
    }

    async function saveGame() {
        if (isSaving) return;
        isSaving = true;
        saveButton.textContent = "Сохранение...";

        const saveData = {
            user: {
                animation_enabled: gameState.animationEnabled,
                auto_save_enabled: gameState.autoSaveEnabled,
                collections_visible: gameState.collectionsVisible,
                index_visible: gameState.indexVisible,
                total_spins: gameState.totalSpins,
                rare_slimes_found: gameState.rareSlimesFound,
                harvest_multiplier: gameState.harvestMultiplier,
                spin_cooldown: gameState.spinCooldown,
                rare_chance_boost: gameState.rareChanceBoost,
                epic_chance_boost: gameState.epicChanceBoost,
                divine_chance_multiplier: gameState.divineChanceMultiplier
            },
            inventory: SLIMES.map(slime => ({
            slime_type: { id: slime.id },
            amount: slime.amount
            })),
            crafts: CRAFTS.map(craft => ({
                recipe: { id: craft.id },
                is_completed: Boolean(craft.created), // Исправлено поле и тип данных
            })),
            collections: COLLECTIONS.map(collection => ({
                collection: { id: collection.id },
                completed: Boolean(collection.completed),
                claimed: Boolean(collection.claimed)
            }))

        };
        
        try {
            await axios.post(`${API_URL}/api/save/`, saveData, {
                headers: { 'Authorization': `Token ${authToken}` }
            });
            console.log("Игра сохранена на сервере");
        } catch (error) {
            console.error('Ошибка сохранения:', error);
        } finally {
            setTimeout(() => {
                isSaving = false;
                saveButton.textContent = "Сохранить";
            }, 1000);
        }
    }

    async function resetOnServer() {
        try {
            await axios.post(`${API_URL}/api/reset/`, {}, {
                headers: { 'Authorization': `Token ${authToken}` }
            });
            return true;
        } catch (error) {
            console.error('Ошибка сброса прогресса:', error);
            return false;
        }
    }

    // Инициализация игры
    async function initGame() {
        await fetchGameData();
        spinButton.addEventListener("click", spin);
        document.getElementById("inventory-toggle").addEventListener("click", toggleInventory);
        document.getElementById("crafter-toggle").addEventListener("click", toggleCrafter);
        saveButton.addEventListener("click", saveGame);
        loadButton.addEventListener("click", fetchGameData);
        resetButton.addEventListener("click", resetProgress);
        
        document.getElementById('animation-toggle').addEventListener('change', function(e) {
            gameState.animationEnabled = e.target.checked;
            saveGame();
        });
        
        document.getElementById('toggle-collections').addEventListener('click', toggleCollections);
        document.getElementById('toggle-index').addEventListener('click', toggleIndex);
        
        // Чит-коды
        document.addEventListener("keydown", handleCheatCode);
        
        checkCollections();
        if (gameState.autoSaveEnabled) {
            startAutoSave();
        }
    }

    function updateAnimationToggle() {
        const toggle = document.getElementById('animation-toggle');
        if (toggle) {
            toggle.checked = gameState.animationEnabled;
        }
    }

    function renderAll() {
        if (inventoryOpen) renderInventory();
        if (crafterOpen) renderCrafter();
        renderCollections();
        renderIndex();
        renderActiveEffects();
    }

    async function resetProgress() {
        if (confirm("Вы уверены, что хотите сбросить весь прогресс? Все ваши данные будут удалены.")) {
            try {
                await resetOnServer();
                await fetchGameData();
                console.log("Прогресс сброшен!");
            } catch (error) {
                console.error('Ошибка сброса прогресса:', error);
            }
        }
    }

    async function spin() {
        if (isSpinning) {
            spinQueue++;
            return;
        }
        
        isSpinning = true;
        spinButton.disabled = true;
        gameState.totalSpins++;
        
        if (gameState.animationEnabled) {
            spinningEffect.style.display = "block";
            spinningEffect.style.animation = "none";
            setTimeout(() => {
                spinningEffect.style.animation = "spin 1s infinite linear";
            }, 10);
            
            let spinCount = 0;
            const spinInterval = setInterval(() => {
                const randomSlime = SLIMES[Math.floor(Math.random() * SLIMES.length)];
                const isKnown = randomSlime.amount > 0;
                
                slimeImage.src = isKnown ? randomSlime.image : UNKNOWN_SLIME_IMAGE;
                nameSpan.textContent = isKnown ? randomSlime.name : "???";
                
                if (isKnown) {
                    rarityBadge.textContent = getRarityName(randomSlime.rarity);
                    rarityBadge.className = `rarity-badge ${randomSlime.rarity}`;
                } else {
                    rarityBadge.textContent = "???";
                    rarityBadge.className = "rarity-badge unknown";
                }
                
                chanceSpan.textContent = isKnown ? randomSlime.chance : "???";
                
                spinCount++;
                if (spinCount > 10) {
                    clearInterval(spinInterval);
                    selectFinalSlime();
                }
            }, 150);
        } else {
            setTimeout(() => {
                selectFinalSlime();
            }, 50);
        }
    }

    async function selectFinalSlime() {
        const maxRange = 10000000000;
        const randomNum = Math.floor(Math.random() * maxRange) + 1;
        
        let selectedSlime = null;
        let candidates = [];
        
        for (const slime of SLIMES) {
            let chanceValue = parseInt(slime.chance.split('/')[1]);
            
            if (slime.rarity === "rare") {
                chanceValue = Math.max(1, Math.floor(chanceValue * (1 - gameState.rareChanceBoost)));
            } else if (slime.rarity === "epic") {
                chanceValue = Math.max(1, Math.floor(chanceValue * (1 - gameState.epicChanceBoost)));
            } else if (slime.rarity === "divine") {
                chanceValue = Math.max(1, Math.floor(chanceValue / gameState.divineChanceMultiplier));
            }
            
            if (randomNum % chanceValue === 0) {
                candidates.push(slime);
            }
        }
        
        selectedSlime = candidates.length > 0 ? 
            candidates[Math.floor(Math.random() * candidates.length)] : 
            SLIMES[0];
        
        const count = gameState.harvestMultiplier;
        selectedSlime.amount += count;
        
        if (gameState.animationEnabled) {
            setTimeout(() => {
                updateSlimeDisplay(selectedSlime);
                finishSpin();
            }, 500);
        } else {
            updateSlimeDisplay(selectedSlime);
            finishSpin();
        }
        
        console.log(`Получено ${count} ${selectedSlime.name}`);
    }

    function updateSlimeDisplay(slime) {
        slimeImage.src = slime.image;
        nameSpan.textContent = slime.name;
        chanceSpan.textContent = slime.chance;
        rarityBadge.textContent = getRarityName(slime.rarity);
        rarityBadge.className = `rarity-badge ${slime.rarity}`;
    }

    function finishSpin() {
        if (gameState.animationEnabled) {
            spinningEffect.style.display = "none";
        }
        
        isSpinning = false;
        
        if (spinQueue > 0) {
            spinQueue--;
            spin();
        } else {
            spinButton.disabled = false;
        }
        
        checkCollections();
        renderAll();
    }

    // Получение названия редкости
    function getRarityName(rarity) {
        const names = {
            'common': 'Обычный',
            'uncommon': 'Необычный',
            'rare': 'Редкий',
            'epic': 'Эпический',
            'legendary': 'Легендарный',
            'mythic': 'Мифический',
            'divine': 'Божественный'
        };
        return names[rarity] || rarity;
    }

    // Переключение видимости инвентаря
    function toggleInventory() {
        if (crafterOpen) {
            crafterOpen = false;
            crafter.style.display = "none";
        }
        
        inventoryOpen = !inventoryOpen;
        inventory.style.display = inventoryOpen ? "block" : "none";
        
        if (inventoryOpen) {
            renderInventory();
        }
    }

    // Отображение инвентаря
    function renderInventory() {
        inventory.innerHTML = "";
        
        SLIMES.forEach(slime => {
            if (slime.amount > 0) {
                const slimeElement = document.createElement("div");
                slimeElement.className = "slime-item";
                slimeElement.innerHTML = `
                    <img src="${slime.image}" alt="${slime.name}">
                    <div>
                        <h3>${slime.name}</h3>
                        <p>Шанс: ${slime.chance}</p>
                        <p>Количество: ${slime.amount}</p>
                        <div class="rarity-badge ${slime.rarity}">${getRarityName(slime.rarity)}</div>
                    </div>
                `;
                inventory.appendChild(slimeElement);
            }
        });
        
        if (inventory.innerHTML === "") {
            inventory.innerHTML = "<p>Ваш инвентарь пуст. Покрутите рулетку, чтобы получить слаймов!</p>";
        }
    }

    // Переключение видимости крафта
    function toggleCrafter() {
        if (inventoryOpen) {
            inventoryOpen = false;
            inventory.style.display = "none";
        }
        
        crafterOpen = !crafterOpen;
        crafter.style.display = crafterOpen ? "block" : "none";
        
        if (crafterOpen) {
            renderCrafter();
        }
    }

    // Отображение рецептов крафта
    function renderCrafter() {
        console.log('CRAFTS:', CRAFTS);
        crafter.innerHTML = "";
        
        CRAFTS.forEach((craft, index) => {
            const craftElement = document.createElement("div");
            craftElement.className = "craft-recipe";
            craftElement.innerHTML = `
                <h3>${craft.name}</h3>
                <p>${craft.effect}</p>
                ${craft.created 
                ? '<div class="crafted-badge">Уже создан!</div>' 
                : `<div class="craft-item">
                    <img src="${craft.image}" alt="${craft.name}">
                    <button class="craft-button" data-index="${index}">Создать</button>
                    </div>`
                }
                <h4>Требуется:</h4>
            `;
            
            craft.cost.forEach(item => {
                const slime = SLIMES.find(s => s.name === item.name);
                const hasEnough = slime && slime.amount >= item.amount;
                
                const costElement = document.createElement("div");
                costElement.className = "craft-item";
                costElement.innerHTML = `
                    <img src="${slime ? slime.image : UNKNOWN_SLIME_IMAGE}" alt="${item.name}">
                    <span>${item.name} - ${item.amount} (${slime ? slime.amount : 0}/${item.amount})</span>
                    ${hasEnough ? "✅" : "❌"}
                `;
                craftElement.appendChild(costElement);
            });
            
            crafter.appendChild(craftElement);
        });
        
        document.querySelectorAll(".craft-button").forEach(button => {
            button.addEventListener("click", function() {
                const index = parseInt(this.getAttribute("data-index"));
                craftItem(index);
            });
        });
    }

    async function craftItem(index) {
        const craft = CRAFTS[index];
        if (craft.created) return;
        
        let canCraft = true;
        craft.cost.forEach(item => {
            const slime = SLIMES.find(s => s.name === item.name);
            if (!slime || slime.amount < item.amount) {
                canCraft = false;
            }
        });
        
        if (canCraft) {
            try {
                
                    craft.cost.forEach(item => {
                        const slime = SLIMES.find(s => s.name === item.name);
                        if (slime) slime.amount -= item.amount;
                    });
                    craft.created = true;
                    saveGame();
                    renderCrafter();
                    if (inventoryOpen) renderInventory();
                    renderActiveEffects();
                
            } catch (e) {
                console.error("Ошибка при создании предмета:", e);
            }
        } else {
            const craftButton = document.querySelector(`.craft-button[data-index="${index}"]`);
            if (craftButton) {
                craftButton.classList.add('craft-error');
                setTimeout(() => craftButton.classList.remove('craft-error'), 500);
            }
        }
    }

    function checkCollections() {
        COLLECTIONS.forEach(collection => {
            let allCompleted = true;
            
            collection.slimes.forEach(req => {
                const slime = SLIMES.find(s => s.name === req.name);
                if (!slime || slime.amount < req.amount) {
                    allCompleted = false;
                }
            });
            
            collection.completed = allCompleted;
        });
    }

    // Отображение коллекций
    function renderCollections() {
        collectionsContainer.innerHTML = "";
        
        COLLECTIONS.forEach(collection => {
            const collectionEl = document.createElement("div");
            collectionEl.className = "collection-item";
            
            let totalSlimes = 0;
            let collectedSlimes = 0;
            
            collection.slimes.forEach(req => {
                totalSlimes += req.amount;
                const slime = SLIMES.find(s => s.name === req.name);
                if (slime) {
                    collectedSlimes += Math.min(slime.amount, req.amount);
                }
            });
            
            const progressPercent = (collectedSlimes / totalSlimes) * 100;
            
            collectionEl.innerHTML = `
                <img class="collection-thumbnail" src="${collection.thumbnail}" alt="${collection.name}">
                <div class="collection-details">
                    <h3>${collection.name}</h3>
                    <p>${collection.description}</p>
                    
                    <div class="collection-slimes">
                        ${collection.slimes.map(req => {
                            const slime = SLIMES.find(s => s.name === req.name);
                            const hasEnough = slime && slime.amount >= req.amount;
                            return `
                                <div class="collection-slime ${hasEnough ? 'completed' : ''}">
                                    <img src="${slime ? slime.image : UNKNOWN_SLIME_IMAGE}" alt="${req.name}">
                                    <span>${req.name} (${slime ? slime.amount : 0}/${req.amount})</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="collection-progress">
                        <div class="progress-bar" style="width: ${progressPercent}%"></div>
                    </div>
                    
                    <div class="collection-reward">Награда: ${collection.reward}</div>
                    
                    ${collection.completed 
                        ? collection.claimed 
                            ? `<div class="collection-status completed">Награда получена!</div>`
                            : `<button class="claim-button" data-id="${collection.id}">Получить награду</button>`
                        : `<div class="collection-status locked">Коллекция не завершена</div>`
                    }
                </div>
            `;
            
            collectionsContainer.appendChild(collectionEl);
        });
        
        document.querySelectorAll(".claim-button").forEach(button => {
            button.addEventListener("click", function() {
                const collectionId = this.getAttribute("data-id");
                claimCollectionReward(collectionId);
            });
        });
    }

    async function claimCollectionReward(collectionId) {
        const collection = COLLECTIONS.find(c => c.id === collectionId);
        if (!collection || !collection.completed || collection.claimed) return;
        
        if (success) {
            collection.claimed = true;
            saveGame();
            renderCollections();
        }
        
    }

    function renderIndex() {
        const indexContainer = document.getElementById("slime-index");
        if (!indexContainer) return;
        
        indexContainer.innerHTML = "";
        
        const totalSlimes = SLIMES.length;
        const collectedSlimes = SLIMES.filter(s => s.amount > 0).length;
        const progressPercent = Math.round((collectedSlimes / totalSlimes) * 100);
        
        const progressHeader = document.createElement("div");
        progressHeader.className = "panel-header";
        progressHeader.innerHTML = `<h3>Прогресс: ${collectedSlimes}/${totalSlimes} (${progressPercent}%)</h3>`;
        indexContainer.appendChild(progressHeader);
        
        const gridContainer = document.createElement("div");
        gridContainer.className = "slime-index-grid";
        indexContainer.appendChild(gridContainer);
        
        const rarityOrder = ['divine', 'mythic', 'legendary', 'epic', 'rare', 'uncommon', 'common'];
        const sortedSlimes = [...SLIMES].sort((a, b) => {
            return rarityOrder.indexOf(a.rarity) - rarityOrder.indexOf(b.rarity);
        });
        
        sortedSlimes.forEach(slime => {
            const isKnown = slime.amount > 0;
            const item = document.createElement("div");
            item.className = `slime-index-item ${isKnown ? 'known' : 'unknown'}`;
            
            item.innerHTML = `
                <div class="slime-index-icon">
                    ${isKnown 
                        ? `<img src="${slime.image}" alt="${slime.name}" width="70" height="70">` 
                        : '?'}
                </div>
                <div class="slime-index-name">${isKnown ? slime.name : '???'}</div>
                ${isKnown 
                    ? `<div class="slime-index-rarity ${slime.rarity}">${getRarityName(slime.rarity)}</div>`
                    : ''}
            `;
            
            if (isKnown) {
                item.title = `${slime.name}\nШанс: ${slime.chance}\nРедкость: ${getRarityName(slime.rarity)}`;
            }
            
            gridContainer.appendChild(item);
        });
    }

    function renderActiveEffects() {
        effectsList.innerHTML = "";
        
        const effects = [];
        
        // Эффекты от амулетов
        CRAFTS.filter(craft => craft.created).forEach(craft => {
            effects.push({
                name: craft.name,
                description: craft.effect,
                icon: craft.image
            });
        });
        
        // Эффекты от коллекций
        COLLECTIONS.filter(c => c.claimed).forEach(collection => {
            effects.push({
                name: collection.name,
                description: `Коллекция: ${collection.reward}`,
                icon: collection.thumbnail
            });
        });
        
        // Системные эффекты
        if (gameState.harvestMultiplier > 1) {
            effects.push({
                name: "Множитель урожая",
                description: `x${gameState.harvestMultiplier} слаймов за спин`,
                icon: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCI+PHBhdGggZD0iTTE5IDE5SDVINmMxLjEgMCAyLS45IDItMnYtN2gtMnY3em0xNC0xNEg1djJoMTZ2MTJoMnYtMTJjMC0xLjEtLjktMi0yLTJ6bS0yIDBIN1Y1aDEwdjB6Ii8+PC9zdmc+"
            });
        }
        
        if (gameState.rareChanceBoost > 0) {
            effects.push({
                name: "Бустер редкости",
                description: `+${Math.round(gameState.rareChanceBoost * 100)}% к шансу редких`,
                icon: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCI+PHBhdGggZD0iTTEyIDJMNi4yNCA4Ljg0IDIgOS43NWw1IDQuODctMS41IDYuMTNMMTIgMTcuNzdMOC4yNCAxOS41bC0xLjUtNi4xM0wxMiAxMi42Nmw1LjI2IDUuNzFsLTEuNSA2LjEzTDEyIDE5Ljc3bDUuNzYgMy43M0wxNi4yNiAxNC42bDUtNC44Ny01LjI2LS45MXoiLz48L3N2Zz4="
            });
        }
        
        // Рендеринг эффектов
        effects.forEach(effect => {
            const effectElement = document.createElement("div");
            effectElement.className = "active-effect";
            effectElement.innerHTML = `
                <img src="${effect.icon}" alt="${effect.name}">
                <div>
                    <strong>${effect.name}</strong>
                    <div>${effect.description}</div>
                </div>
            `;
            effectsList.appendChild(effectElement);
        });
        
        if (effects.length === 0) {
            effectsList.innerHTML = "<p>Нет активных эффектов</p>";
        }
    }

    function toggleCollections() {
        gameState.collectionsVisible = !gameState.collectionsVisible;
        document.querySelector('.collections-area').style.display = 
            gameState.collectionsVisible ? 'block' : 'none';
        document.getElementById('toggle-collections').textContent = 
            gameState.collectionsVisible ? 'Скрыть коллекции' : 'Показать коллекции';
        saveGame();
    }
    
    function toggleIndex() {
        gameState.indexVisible = !gameState.indexVisible;
        document.querySelector('.index-area').style.display = 
            gameState.indexVisible ? 'block' : 'none';
        document.getElementById('toggle-index').textContent = 
            gameState.indexVisible ? 'Скрыть индекс' : 'Показать индекс';
        saveGame();
    }

    function startAutoSave() {
        autoSaveInterval = setInterval(() => {
            saveGame();
            console.log("Автосохранение...");
        }, 30000);
    }

    function handleCheatCode(e) {
        if (e.ctrlKey || e.altKey || e.metaKey) return;
        
        cheatBuffer += e.key.toUpperCase();
        
        for (const code in cheatCodes) {
            if (cheatBuffer.includes(code)) {
                if (activateCheat(code)) {
                    cheatBuffer = "";
                    return;
                }
            }
        }
        
        if (cheatBuffer.length > 20) {
            cheatBuffer = "";
        }
        
        cheatSequence.push(e.key);
        if (cheatSequence.length > 10) cheatSequence.shift();
        
        const konami = ["ArrowUp", "ArrowUp", "ArrowDown", "ArrowDown", 
                        "ArrowLeft", "ArrowRight", "ArrowLeft", "ArrowRight",
                        "b", "a"];
        
        if (cheatSequence.join(",") === konami.join(",")) {
            activateCheat("MASTER");
            cheatSequence = [];
        }
    }

    function activateCheat(code) {
        if (cheatCodes[code]) {
            const message = cheatCodes[code]();
            showCheatNotification(message);
            
            renderAll();
            saveGame();
            
            return true;
        }
        return false;
    }

    function showCheatNotification(message) {
        const notification = document.createElement("div");
        notification.id = "cheat-notification";
        notification.innerHTML = `
            <div class="cheat-message">${message}</div>
            <div class="cheat-label">Чит-код активирован</div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = "cheatFade 0.5s forwards";
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 500);
        }, 3000);
    }

    // Запуск игры
    window.addEventListener("DOMContentLoaded", initGame);
    </script>
</body>
</html>